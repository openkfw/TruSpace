#!/bin/bash

echo "# Post-commit hook that uses --amend with loop protection"

# Prevent infinite loops
if [ "$GIT_AMENDING_VERSION" = "1" ]; then
    exit 0
fi

COMMIT_HASH=$(git rev-parse HEAD)
SHORT_HASH=$(git rev-parse --short HEAD)
COMMIT_DATE=$(git show -s --format=%ci HEAD)

cat > frontend/src/version.ts << EOF
// Auto-generated - DO NOT EDIT
export const COMMIT_HASH = '$COMMIT_HASH';
export const SHORT_COMMIT_HASH = '$SHORT_HASH';
export const COMMIT_DATE = '$COMMIT_DATE';
EOF

cat > backend/src/version.ts << EOF
// Auto-generated - DO NOT EDIT
export const COMMIT_HASH = '$COMMIT_HASH';
export const SHORT_COMMIT_HASH = '$SHORT_HASH';
export const COMMIT_DATE = '$COMMIT_DATE';
EOF

git add frontend/src/version.ts backend/src/version.ts
GIT_AMENDING_VERSION=1 git commit --amend --no-edit

echo "Updated version files with commit hash $SHORT_HASH"