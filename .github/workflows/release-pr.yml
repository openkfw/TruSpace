# On pull request to 'release' branch
# A) Make sure that the pull request comes from 'main' branch
# B) Scan for npm vulnerabilities
# C) Test whether application starts
# parallel to A) In codeql.yml, run code scanning

name: Protect PRs to `release`

on:
  pull_request:
    branches:
      - release

jobs:
  restrict_pr:
    name: Ensure PRs to `release` come from `main`
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is from main
        run: |
          if [ "${{ github.head_ref }}" != "main" ]; then
            echo "❌ Pull requests to `release` must come from `main` only."
            exit 1
          else
            echo "✅ PR is from `main`."
          fi

  npm_audit:
    name: Scan for npm vulnerabilities
    runs-on: ubuntu-latest
    needs: restrict_pr
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high

  start_app:
    name: Test whether application starts correctly
    runs-on: ubuntu-latest
    needs: npm_audit
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4

      - name: Ensure script is executable
        run: chmod +x ./start.sh

      - name: Start the application in background
        run: |
          echo "Starting application..."
          ./start.sh &
          APP_PID=$!
          echo $APP_PID > app.pid

      - name: Wait for health check (max 5 minutes)
        run: |
          timeout=300       # 5 minutes
          interval=5
          elapsed=0

          echo "Waiting for application to become healthy (max 5 minutes)..."

          while ! curl -s -f http://localhost:3000/health; do
            if [ $elapsed -ge $timeout ]; then
              echo "❌ Application did not become healthy within 5 minutes."
              exit 1
            fi
            echo "ℹ️ Still waiting... ($elapsed seconds)"
            sleep $interval
            elapsed=$((elapsed + interval))
          done

          echo "✅ Application is healthy!"

      - name: Stop background application
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill "$(cat app.pid)" || true
          fi
