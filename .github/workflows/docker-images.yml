# TruSpace backend and frontend images
# On push to 'release' branch
# Build and push to Docker Hub
# Test and scan for insecurities
# If failure: clean up images
# If success: push images

name: Docker Images CI

on:
  push:
    branches: ["release"]
    tags: ["v*"]

env:
  REGISTRY: docker.io
  BACKEND_IMAGE_NAME: kfwopensource/truspace-backend
  FRONTEND_IMAGE_NAME: kfwopensource/truspace-frontend
  ENABLE_CODE_SCANNING: true
  STAGING_TAG: scan-${{ github.sha }}

jobs:
  #####################################################################
  # BUILD & PUSH MULTIARCH STAGING IMAGES
  #####################################################################
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # BACKEND - build multiarch → push to staging tag
      - name: Backend - Build & Push (staging)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.STAGING_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # FRONTEND - build multiarch → push to staging tag
      - name: Frontend - Build & Push (staging)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.STAGING_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max


  #####################################################################
  # SECURITY SCAN USING TRIVY AGAINST THE STAGING IMAGES
  #####################################################################
  scan:
    needs: build
    runs-on: ubuntu-latest

    steps:
      # Backend scan
      - name: Scan Backend with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.STAGING_TAG }}
          format: sarif
          output: backend-trivy-results.sarif

      - name: Upload backend scan to GitHub Security tab
        if: ${{ env.ENABLE_CODE_SCANNING == 'true' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: backend-trivy-results.sarif

      - name: Upload backend scan as artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-trivy-report
          path: backend-trivy-results.sarif

      # Frontend scan
      - name: Scan Frontend with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.STAGING_TAG }}
          format: sarif
          output: frontend-trivy-results.sarif

      - name: Upload frontend scan to GitHub Security tab
        if: ${{ env.ENABLE_CODE_SCANNING == 'true' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: frontend-trivy-results.sarif

      - name: Upload frontend scan as artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-trivy-report
          path: frontend-trivy-results.sarif


  #####################################################################
  # FAILURE → CLEANUP STAGING IMAGES
  #####################################################################
  cleanup:
    needs: scan
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Remove staging images
        run: |
          docker buildx imagetools rm ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.STAGING_TAG }} || true
          docker buildx imagetools rm ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.STAGING_TAG }} || true


  #####################################################################
  # SUCCESS → RETAG & PUSH ALL FINAL TAGS
  #####################################################################
  promote:
    needs: scan
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Generate backend + frontend metadata tags
      - name: Backend - Extract metadata
        id: backend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      - name: Frontend - Extract metadata
        id: frontend-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest

      # RETAG FROM STAGING → FINAL TAGS
      - name: Promote Backend Tags
        run: |
          echo "${{ steps.backend-meta.outputs.tags }}" | grep -v '^$' | while read tag; do
            docker buildx imagetools create \
              -t "$tag" \
              ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.STAGING_TAG }}
          done

      - name: Promote Frontend Tags
        run: |
          echo "${{ steps.frontend-meta.outputs.tags }}" | grep -v '^$' | while read tag; do
            docker buildx imagetools create \
              -t "$tag" \
              ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.STAGING_TAG }}
          done