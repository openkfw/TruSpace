# CI to mirror our GitHub repository main branch to OpenCode GitLab main branch
# Backstory: tried the official pull mirroring component but didnt work
# Instructions on the mirroring here: https://guide.opencode.de/projekte/spiegeln/#so-funktioniert-die-pull-spiegelung
# The exact component can be found here: https://gitlab.opencode.de/pull-mirroring/component

stages:
  - mirroring

variables:
  GIT_DEPTH: 0

mirror_github_main:
  stage: mirroring
  image: alpine/git

  before_script:
    - apk update
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"

    # Clone only main from GitHub
    - git clone --branch main --single-branch https://github.com/openkfw/TruSpace.git repo
    - cd repo

    # Add GitLab target remote with token
    - git remote add target "https://${GITLAB_PAT_NAME}:${GITLAB_PAT}@${CI_SERVER_FQDN}/${CI_PROJECT_PATH}.git"

  script:
    - echo "Pushing GitHub main â†’ GitLab main"
    - git push target main:main --force
    - git push target --tags --force

  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" || $CI_PIPELINE_SOURCE == "schedule"'
